<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Responsive web app for finding trash & recycling scheduling information">
    <meta name="author" content="City of Tempe Enterprise GIS Group">
    <link rel="shortcut icon" href="../images/favicon.png">

    <title>Find Your Solid Waste and Recycling Schedule</title>

    <!-- Bootstrap core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/geosearch-template.css" rel="stylesheet">

    <!-- Bootstrap-map-js -->
    <link rel="stylesheet" type="text/css" href="//js.arcgis.com/3.13/esri/css/esri.css">   
    <link rel="stylesheet" type="text/css" href="css/bootstrapmap.min.css">   
    <style type="text/css">
        
      #mapDiv {
        min-height: 100%; 
        max-height: 100%; 
      }

      .simpleGeocoder {
        margin-right: 5px;
      }

      
      /* Option 2: Geosearch in nav;
      .simpleGeocoder .esriGeocoderContainer {
        width: 180px;
      }
      .simpleGeocoder .esriGeocoder input {
        width: 118px;
      }
      @media (max-width: 767px) {
        .navbar-form .form-group {
          float: left;
        }
        .simpleGeocoder {
          margin-right: 7px;
        }
      }
      */
        
    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../bootstrap_v3/docs-assets/js/html5shiv.js"></script>
      <script src="../bootstrap_v3/docs-assets/js/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
             <div id="geosearch"></div>
                   <!--<button id="btnGeosearch" type="submit" class="btn btn-success">Search</button>-->
                           </div>
          <!--<a class="navbar-brand" href="#"></a>-->

        <!--<div class="navbar-collapse">
          <ul class="nav navbar-nav">
           
          </ul>
          <!--Option 1: Modal-->
            <!-- 
          <ul class="nav navbar-nav">
            <li><a id="geosearchNav" href="#">Geosearch</a></li>
          </ul>
                -->
          <!--Option 2: Insert in nav bar-->
          <!--<div class="navbar-form navbar-right">
            <div class="form-group">
             
            </div>
          </div> 
        </div><!--/.nav-collapse -->
      </div>
    </div>

   

    <!-- Bootstrap-map-js -->
    <div id="mapDiv"></div>

          <script type="text/javascript">
           var package_path = "//esri.github.com/bootstrap-map-js/src/js";
           var dojoConfig = {
               packages: [{
                   name: "application",
                   location: package_path
               }]
           };
    </script>
    <script src="//js.arcgis.com/3.13compact"></script>
    <script>
        //var geocoderZoomScale = 14;
        var DefaultExtent = {};
        DefaultExtent.xmin = -12461474;
        DefaultExtent.ymin = 3949527;
        DefaultExtent.xmax = -12457708;
        DefaultExtent.ymax = 3951465;

        var DefaultAddress = ""

        var trashLayer;
        var yardWasteLayer;
        var recyclingLayer;

        require(["esri/map",
          "esri/dijit/Scalebar",
          "esri/dijit/Geocoder",
          "dojo/promise/all",
          "esri/dijit/InfoWindow",
          "esri/InfoTemplate",
          "esri/graphic",
          "esri/geometry/Multipoint",
          "esri/symbols/PictureMarkerSymbol",
          "esri/dijit/Popup",
          "dojo/dom",
          "dojo/on",
          "application/bootstrapmap",
          "dojo/domReady!"],
          function (Map, Scalebar, Geocoder, all, InfoWindow, InfoTemplate, Graphic, Multipoint, PictureMarkerSymbol, Popup, dom, on, BootstrapMap) {
              "use strict";

              // Get a reference to the ArcGIS Map class
              var map = BootstrapMap.create("mapDiv", {
                  basemap: "gray",
                  center: [-111.9385, 33.4204],
                  zoom: 8,
                  logo: false,
                  scrollWheelZoom: true

              });


              // Create widget
              var geocoder = new Geocoder({
                  value: DefaultAddress,
                  maxLocations: 3,
                  autoComplete: true,
                  arcgisGeocoder: true,
                  autoNavigate: true,
                  map: map
              }, "geosearch");
              geocoder.startup();
              geocoder.on("select", geocodeSelect);
              //geocoder.on("findResults", geocodeResults);
              geocoder.on("clear", clearFindGraphics);
              dojo.byId("geosearch_input").placeholder = "Enter Your Address";

              // Geosearch functions
              //on(dom.byId("geosearch"), "click", geosearch);
              //on(dom.byId("btnClear"), "click", clearFindGraphics);

              map.on("load", function () {
                  map.infoWindow.offsetY = 10;
                  map.infoWindow.anchor = "bottom";
                  map.infoWindow.set("highlight", false);
                  

                  var t_ext = new esri.geometry.Extent({ "xmin": DefaultExtent.xmin, "ymin": DefaultExtent.ymin, "xmax": DefaultExtent.xmax, "ymax": DefaultExtent.ymax, "spatialReference": { "wkid": 102100} });
                  map.setExtent(t_ext);
                  map.setLevel(14);
                  addRecycling();
              });

              function geosearch() {
                  var def = geocoder.find();
                  def.then(function (res) {
                      geocodeResults(res);
                  });
              }

              function geocodeSelect(item) {
                  var g = (item.graphic ? item.graphic : item.result.feature);
                  g.setSymbol(sym);
                  addPlaceGraphic(item.result, g.symbol);
                  console.log('select');
              }

              function geocodeResults(places) {
                  console.log('results');
                  places = places.results;
                  if (places.length > 0) {
                      clearFindGraphics();
                      var symbol = sym;
                      // Create and add graphics with pop-ups
                      for (var i = 0; i < places.length; i++) {
                          addPlaceGraphic(places[i], symbol);
                          break;
                      }
                      //zoomToPlaces(places);
                  } else {
                      alert("Sorry, address or place not found.");
                  }
              }

              function addPlaceGraphic(item, symbol) {
                  map.graphics.clear();
                  var place = {};
                  var infoTemplate, pt, graphic;
                  var tempAttributes = { trash: "", recycling: "", mixedBulk: "" };
                  pt = item.feature.geometry;
                  place.address = item.name;
                  place.score = item.feature.attributes.score;

                  var trashQuery = runPWQuery(pt, trashLayer, "trash");
                  var yardQuery = runPWQuery(pt, yardWasteLayer, "yardwaste");
                  var recycleQuery = runPWQuery(pt, recyclingLayer, "recycling");

                  all([trashQuery, recycleQuery, yardQuery]).then(function (results) {

                      //receive query responses, update attributes and add graphics

                      for (var i = 0; i < results.length; i++) {
                          //var values = [];
                          //var tstr;
                          var temp_val;
                          var myresponse = results[i];
                          //console.log(results[i]);

                          for (var il = 0; il < myresponse.features.length; il++) {
                              if (myresponse.features[il].attributes["MONDAY"] == "Yes") {
                                  temp_val = "Monday";
                              }
                              else if (myresponse.features[il].attributes["TUESDAY"] == "Yes") {
                                  temp_val = "Tuesday";
                              }
                              else if (myresponse.features[il].attributes["WEDNESDAY"] == "Yes") {
                                  temp_val = "Wednesday";
                              }
                              else if (myresponse.features[il].attributes["THURSDAY"] == "Yes") {
                                  temp_val = "Thursday";
                              }
                              else if (myresponse.features[il].attributes["FRIDAY"] == "Yes") {
                                  temp_val = "Friday";
                              }
                              else {
                                  //temp_val = "Other";
                                  temp_val = myresponse.features[il].attributes["DESCRIPT"];
                              }

                              if (i == 0) {
                                  tempAttributes.trash = temp_val;
                              }
                              else if (i == 1) {
                                  tempAttributes.recycling = temp_val;
                              }
                              else if (i == 2) {
                                  tempAttributes.mixedBulk = temp_val;
                              }

                              infoTemplate = new InfoTemplate("<b>Scheduling Information</b>", "<b>Trash:</b> ${trash}<br/><b>Recycling:</b> ${recycling}<br/><b>Mixed Bulk:</b> ${mixedBulk}");
                              graphic = new Graphic(pt, symbol, tempAttributes, infoTemplate);
                              map.graphics.add(graphic);
                              //map.centerAt(pt);

                              //console.log(graphic);
                          }
                      }
                      postProcessTasks(graphic, pt);
                     
                      
                  });

              }

              function postProcessTasks(in_graphic, in_pt) {

                  map.centerAndZoom(in_pt, 18);
                  map.infoWindow.setContent(in_graphic.getContent());
                  map.infoWindow.setTitle(in_graphic.getTitle());
                  var myTimeout = setTimeout(function () { map.infoWindow.show(in_pt, map.getInfoWindowAnchor(in_pt)); }, 500);
                  console.log(in_pt);
              }
              function clearFindGraphics() {
                  map.infoWindow.hide();
                  map.graphics.clear();
              }

              function createPictureSymbol(url, xOffset, yOffset, xWidth, yHeight) {
                  return new PictureMarkerSymbol(
                  {
                      "angle": 0,
                      "xoffset": xOffset, "yoffset": yOffset, "type": "esriPMS",
                      "url": url,
                      "contentType": "image/png",
                      "width": xWidth, "height": yHeight
                  });
              }

              var sym = createPictureSymbol("assets/blue-pin.png", 0, 12, 13, 24);

              // Show modal dialog, hide nav
              $(document).ready(function () {
                  // Close menu
                  $('.nav a').on('click', function () {
                      $(".navbar-toggle").click();
                  });
                  // Geosearch nav menu is selected
                  $("#geosearchNav").click(function (e) {
                      $("#geosearchModal").modal("show");
                      // Bootstrap work-around
                      $("body").css("margin-right", "0px");
                      $(".navbar").css("margin-right", "0px");
                  });
              });

              function addRecycling() {
                  var recyclingInfoTemplate = new esri.InfoTemplate();
                  recyclingInfoTemplate.setTitle("${NAME}");
                  recyclingInfoTemplate.setContent("<b>Owned by: </b>${OWNER}<br/>" +
                                          "<b>Location Type: </b>${FEATURECODE}<br/>" +
                                          "<b>Address: </b>${FULLADDR}<br/>" +
                                          "<b>Phone: </b>${PHONE}<br/><br/>" +
                                          "<a href='mailto:tempe311@tempe.gov' target='_blank'>Email Tempe 311</a>");


                  var recyclingFeatureLayer = new esri.layers.FeatureLayer("http://gis.tempe.gov/arcgis/rest/services/Applications/GovernmentServicesPublic/FeatureServer/1", {
                      infoTemplate: recyclingInfoTemplate,
                      outFields: ["*"]
                  });
                  map.addLayer(recyclingFeatureLayer);

                  addPWLayers();
              }
          });

        function addPWLayers() {
                            
            yardWasteLayer = new esri.layers.FeatureLayer("http://gis.tempe.gov/arcgis/rest/services/Applications/GovernmentServicesPublic/FeatureServer/11", { outFields: ["*"], visible: false });
            recyclingLayer = new esri.layers.FeatureLayer("http://gis.tempe.gov/arcgis/rest/services/Applications/GovernmentServicesPublic/FeatureServer/10", { outFields: ["*"], visible: false });
            trashLayer = new esri.layers.FeatureLayer("http://gis.tempe.gov/arcgis/rest/services/Applications/GovernmentServicesPublic/FeatureServer/9", { outFields: ["*"], visible: false });

            map.addLayers([trashLayer, yardWasteLayer, recyclingLayer]);
                     
        }

        function runPWQuery(in_geometry , in_fl , in_container_id) {
            var query = new esri.tasks.Query();
            query.returnGeometry = true;
            query.outFields = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "DESCRIPT"];
            query.geometry = in_geometry;

           var promise = in_fl.queryFeatures(query, function(myresponse, io) {
                  var temp_val;
                  var values = [];
                  var tstr;
                  for (var il = 0; il < myresponse.features.length; il++) {
                      if (myresponse.features[il].attributes["MONDAY"] == "Yes") {
                          temp_val = "Monday";
                      }
                      else if (myresponse.features[il].attributes["TUESDAY"] == "Yes") {
                          temp_val = "Tuesday";
                      }
                      else if (myresponse.features[il].attributes["WEDNESDAY"] == "Yes") {
                          temp_val = "Wednesday";
                      }
                      else if (myresponse.features[il].attributes["THURSDAY"] == "Yes") {
                          temp_val = "Thursday";
                      }
                      else if (myresponse.features[il].attributes["FRIDAY"] == "Yes") {
                          temp_val = "Friday";
                      }
                      else {
                          //temp_val = "Other";
                          temp_val = myresponse.features[il].attributes["DESCRIPT"];
                      }
                  }


                  var statCount = myresponse.features.length;
                  if (statCount >= 1) {                    
                      $("#" + in_container_id).html(temp_val);
                                       }
                  else {
                      $("#" + in_container_id).html("");
                  }

                  return temp_val;
                  
              }, function (error) {
                  console.log(dojo.toJson(error, true));
              });

              //return promise
              return promise;
                          
        }

        function renderPWQuery() {

        }

       </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
      <form method="post" action="" id="Form1">
<div class="aspNetHidden">
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUJNzM2NTgwNzkyZGQAWkmO4UVL3s0mD7oPzRy82GzOiFo9l/ePWZXHeoLdLw==" />
</div>

<div class="aspNetHidden">

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="C00B45A4" />
</div></form>
  </body>
    
</html>
